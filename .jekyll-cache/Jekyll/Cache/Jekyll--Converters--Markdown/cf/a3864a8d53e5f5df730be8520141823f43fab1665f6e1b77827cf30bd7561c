I"‚$<h3 id="compute-agentåŠŸèƒ½">Compute AgentåŠŸèƒ½</h3>
<p>ä¸çŸ¥é“ä»£ç å¹²äº†ä»€ä¹ˆå°±ç›²ç›®å»è¯»çš„è¯ï¼ŒåŸºæœ¬æ˜¯äº‹å€åŠŸåŠçš„ç»“æœã€‚</p>

<p>Ceilometeré€šè¿‡Agentæ¨¡å—å»pollingè™šæ‹Ÿæœºæˆ–è€…OpenStackä¸­éœ€è¦çš„ä¿¡æ¯ï¼Œç„¶åå°†å®ƒä¼ é€è‡³Ceilometer Event Busä¸­å»ã€‚å¯¹äºè™šæ‹Ÿæœºçš„å…·ä½“ä¿¡æ¯ï¼ˆCPUï¼ŒMemory,Disk I/O,Network I/Oï¼‰éœ€è¦å»è™šæ‹Ÿæœºæ‰€è¿è¡Œçš„èŠ‚ç‚¹ä¸Šè·å–ï¼ˆå…¶å®ä½¿ç”¨libvirtå¯ä»¥ç›´æ¥tcpåˆ°å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼‰ï¼Œæ‰€ä»¥éœ€è¦å°†Agentæ¨¡å—ä¸¢åˆ°è®¡ç®—æœºç‚¹ä¸Šï¼Œç„¶åé€šè¿‡Libvirtè·å–è™šæ‹ŸæœºçŠ¶æ€ï¼Œè¿™å°±æ˜¯Compute Agentçš„åŠŸèƒ½ã€‚</p>

<h3 id="å…¥å£æ–‡ä»¶">å…¥å£æ–‡ä»¶</h3>
<p>Compute Agentä»¥OpenStack Serviceï¼ˆOpenStackæœåŠ¡åˆ†ä¸ºServiceå’ŒWSGI Serviceï¼‰çš„å½¢å¼è¿è¡Œåœ¨è®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œå®ƒç”±ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å¼€å¯ï¼Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å®‰è£…æ—¶ç”Ÿæˆï¼ˆç›®å‰æœ€æ–°ç‰ˆæœ¬ï¼Œæ¯”Grizzlyæ–°æ¯”Havanaæ—§â€¦â€¦ï¼‰ã€‚å¦‚æœæ˜¯Grizzlyç‰ˆæœ¬ï¼Œå¯ä»¥å»<code class="highlighter-rouge">ceilometer/bin</code>ä¸‹æ‰¾<code class="highlighter-rouge">ceilometer-agent-compute</code>æ–‡ä»¶ï¼Œå¦‚æœæ˜¯å’Œæˆ‘ç”¨çš„ä¸€æ ·ï¼Œé€‰æœ€æ–°ç‰ˆæœ¬ï¼Œå°±ç›´æ¥çœ‹<code class="highlighter-rouge">ceilometer/setup.cfg</code>æ–‡ä»¶</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>console_scripts =
    ceilometer-agent-central = ceilometer.central.manager:agent_central
    ceilometer-agent-compute = ceilometer.compute.manager:agent_compute
    ceilometer-dbsync = ceilometer.storage:dbsync
    ceilometer-collector = ceilometer.collector.service:collector
    ceilometer-collector-udp = ceilometer.collector.service:udp_collector
</code></pre></div></div>

<p>è¿™é‡Œè¡¨æ˜ceilometer-agent-computeä»<code class="highlighter-rouge">ceilometer.compute.manager:agent_compute</code>è¿è¡Œ</p>

<h3 id="å…¥å£å‡½æ•°">å…¥å£å‡½æ•°</h3>
<p>å…¥å£å‡½æ•°å¾ˆç®€å•ï¼ŒåŸºæœ¬å°±æŠŠcomputeçš„åŠŸèƒ½å†™æ¸…æ¥šäº†ï¼Œæˆ‘è¿™ä¸ªç‰ˆæœ¬åœ¨<code class="highlighter-rouge">ceilometer/ceilometer/compute/manager.py</code>ä¸­</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def agent_compute():
    eventlet.monkey_patch()
    gettextutils.install('ceilometer')
    service.prepare_service(sys.argv)
    os_service.launch(rpc_service.Service(cfg.CONF.host,
                                          'ceilometer.agent.compute',
                                          AgentManager())).wait()
</code></pre></div></div>

<p>å‰4è¡Œéƒ½æ˜¯å‡†å¤‡æ­¥éª¤ï¼ŒåŒ…æ‹¬å‚æ•°è·å–ç­‰åŠŸèƒ½ï¼ŒçœŸæ­£å®ç°åŠŸèƒ½çš„æ˜¯æœ€åä¸€è¡Œ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>os_service.launch(rpc_service.Service(cfg.CONF.host,'ceilometer.agent.compute',AgentManager())).wait()
</code></pre></div></div>

<p>æˆ‘å†æŠŠå®ƒå±•å¼€</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceilometer.openstack.common.service.launch(
    ceilometer.openstack.common.rpc.service.Service(
        cfg.CONF.host,'ceilometer.agent.compute',AgentManager()
        )
    ).wait()
</code></pre></div></div>

<p>ä¸¤ä¸ªServiceå‡½æ•°çš„ä½œç”¨éƒ½æ˜¯OpenStackæœåŠ¡çš„åŸºæœ¬ä½œç”¨â€”â€”â€”â€”å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼ˆå…³äºæœåŠ¡æˆ‘æœ‰æ—¶é—´å†è¯¦ç»†å†™ä¸€ä¸ªåˆ†ææœåŠ¡çš„åšå®¢ï¼‰ï¼Œç„¶åå¯åŠ¨æœåŠ¡åï¼Œæ‰§è¡ŒAgentManager()ï¼ˆå®ƒç»§æ‰¿è‡ª<code class="highlighter-rouge">ceilometer.agent.AgentManager</code>ï¼‰ä¸­çš„<code class="highlighter-rouge">initialize_service_hook()</code>å‡½æ•°</p>

<h3 id="agentpy">agent.py</h3>
<p>è¿™ä¸ªæ¨¡å—ä¸­åŒ…å«äº†éå¸¸é‡è¦çš„ä¸¤ä¸ªç±»<code class="highlighter-rouge">AgentManager</code>å’Œ<code class="highlighter-rouge">PollingTask</code>ï¼ŒCompute Agentå’ŒCentral Agentçš„Manageréƒ½ç»§æ‰¿è‡ªAgentManger</p>

<p>åœ¨AgentManagerçš„æ„é€ å‡½æ•°ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€å¥</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self.pollster_manager = extension_manager
</code></pre></div></div>

<p>å®ƒæ˜¯ä¸€ç§åŠ¨æ€åŠ è½½æ¨¡å—çš„æœºåˆ¶(è§<a href="/2013/06/09/learn-python-stevedore-module-in-detail.html">å­¦ä¹ PythonåŠ¨æ€æ‰©å±•åŒ…stevedore</a>)ï¼Œå®ƒå°†è½½å…¥æ‰€æœ‰å®ƒå¯ä»¥ç”¨æ¥è·å–è™šæ‹ŸæœºçŠ¶æ€çš„æ¨¡å—ã€‚åœ¨Compute Agentçš„æ„é€ å‡½æ•°ä¸­è¯´æ˜äº†æ˜¯<code class="highlighter-rouge">namespace='ceilometer.poll.compute'</code>ï¼Œå³<code class="highlighter-rouge">setup.cfg</code>ä¸­çš„ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ceilometer.poll.compute =
    diskio = ceilometer.compute.pollsters:DiskIOPollster
    cpu = ceilometer.compute.pollsters:CPUPollster
    net = ceilometer.compute.pollsters:NetPollster
    instance = ceilometer.compute.pollsters:InstancePollster
</code></pre></div></div>

<p>è¿™æ ·å°±è®©Agentæ˜ç™½äº†å®ƒè¦è°ƒç”¨å“ªäº›Pollsteræ¥è·å–è™šæ‹Ÿæœºä¿¡æ¯</p>

<p>æ„é€ å‡½æ•°ä¸­è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self._inspector = virt_inspector.get_hypervisor_inspector()
</code></pre></div></div>

<p>inspectorçš„ä½œç”¨æ˜¯è·å–è™šæ‹Ÿæœºä¿¡æ¯çš„ï¼Œå®ƒç°åœ¨åªæœ‰ä¸€ç§å®ç°æ–¹å¼â€”Libvirt</p>

<p>æ¥ç€æ˜¯å¯åŠ¨æœåŠ¡æ—¶è¿è¡Œçš„é‚£ä¸ªå‡½æ•°<code class="highlighter-rouge">initialize_service_hook()</code>äº†</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def initialize_service_hook(self, service):
    self.service = service
    for interval, task in self.setup_polling_tasks().iteritems():
        self.service.tg.add_timer(interval,
                                  self.interval_task,
                                  task=task)
</code></pre></div></div>

<p>å¤§æ¦‚çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå®ƒåˆ©ç”¨<code class="highlighter-rouge">setup_polling_tasks()</code>è¿”å›çš„è¿­ä»£å™¨ï¼ˆintervalæ˜¯é—´éš”æ—¶é•¿ï¼Œtaskæ˜¯æ‰§è¡Œçš„ä»»åŠ¡ï¼‰ï¼Œå°†interval_task(task)ä»¥intervalçš„é—´éš”æ‰§è¡Œ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def interval_task(self, task):
    task.poll_and_publish()
</code></pre></div></div>

<p>é‚£ä¹ˆtaskæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªå°±æ˜¯å‰é¢æåˆ°çš„<code class="highlighter-rouge">PollingTask</code>ç±»äº†ï¼ŒCompute Agentçš„PollingTaskåœ¨<code class="highlighter-rouge">manager.py</code>æ–‡ä»¶ä¸­</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class PollingTask(agent.PollingTask):
    def poll_and_publish_instances(self, instances):
        with self.publish_context as publisher:
            for instance in instances:
                if getattr(instance, 'OS-EXT-STS:vm_state', None) != 'error':
                    for pollster in self.pollsters:
                        publisher(list(pollster.obj.get_counters(self.manager,instance)))

    def poll_and_publish(self):
        self.poll_and_publish_instances(
            self.manager.nv.instance_get_all_by_host(cfg.CONF.host))
</code></pre></div></div>

<p>æˆ‘åªå†™äº†æ‘˜äº†å¿…è¦éƒ¨åˆ†ï¼Œ<code class="highlighter-rouge">poll_and_publish</code>é€šè¿‡nova_clientè·å¾—ç°æœ‰çš„æ‰€æœ‰è™šæ‹Ÿæœºï¼Œç„¶åè°ƒç”¨<code class="highlighter-rouge">poll_and_pusblish_instances</code></p>

<p>é€šè¿‡pollster.get_countersè·å¾—è™šæ‹Ÿæœºçš„æ•°æ®ï¼Œç„¶åé€šè¿‡pipelineå°†æ•°æ®è½¬æ¢å’Œä¼ é€ç»™publisherï¼Œç”±publisherå‘é€åˆ°MQä¸­å»ã€‚è¿™é‡Œæ¶‰åŠåˆ°çš„pipelineå’Œpublisherå•ç‹¬æ‹¿å‡ºæ¥ç ”ç©¶ï¼Œä¹‹åå†å†™ã€‚</p>

<h3 id="pollsterspy">pollsters.py</h3>
<p>è¿™ä¸ªæ–‡ä»¶ä½äº<code class="highlighter-rouge">ceilometer/ceilometer/compute</code>ä¸‹ï¼Œå®ƒæ˜¯è½®è¯¢è™šæ‹Ÿæœºä¿¡æ¯çš„ä¸»è¦ä»£ç æ‰€åœ¨</p>

<p>ä»¥cpuä¸ºä¾‹è¯´æ˜</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class CPUPollster(plugin.ComputePollster):
    def get_counters(self, manager, instance):
        instance_name = _instance_name(instance)
        cpu_info = manager.inspector.inspect_cpus(instance_name)
        yield make_counter_from_instance(instance,
                                         name='cpu',
                                         type=counter.TYPE_CUMULATIVE,
                                         unit='ns',
                                         volume=cpu_info.time,
                                         )
</code></pre></div></div>

<p>è¿™é‡Œçœç•¥äº†å¤§éƒ¨åˆ†ä»£ç ï¼Œåªæ˜¯ç»™å‡ºä¸€ä¸ªPollsterçš„å†™æ³•ï¼Œå®ƒéœ€è¦ä¸€ä¸ªget_countersçš„å‡½æ•°ï¼Œç”¨æ¥è¿”å›è´§å–åˆ°çš„è™šæ‹Ÿæœºæ•°æ®ã€‚æ‰§è¡Œè·å–çš„ä»£ç æ¥è‡ªäºinspectorï¼Œä¹Ÿå°±æ˜¯<code class="highlighter-rouge">ceilometer/ceilometer/compute/virt/inspector.py</code>ä¸­çš„åŠŸèƒ½äº†</p>

<h3 id="inspectorpy">inspector.py</h3>
<p>inspectorè¦åšçš„å°±æ˜¯å»è·å¾—è™šæ‹Ÿæœºæ•°æ®äº†ï¼Œå®ƒå¯ä»¥æœ‰å¤šé‡æ–¹å¼ï¼Œæš‚æ—¶ceilometeråªå†™äº†åŸºäºlibvirtè·å¾—çš„ã€‚æš‚æ—¶inspectorå¯ä»¥åšçš„å†…å®¹ä¸»è¦æœ‰ä¸€ä¸‹å‡ ä¸ªï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def inspect_instances(self):
def inspect_cpus(self, instance_name):
def inspect_vnics(self, instance_name):
def inspect_disks(self, instance_name):
</code></pre></div></div>

<p>é€šè¿‡Libvirtè·å¾—è™šæ‹Ÿæœºä¿¡æ¯æ–¹æ³•åº”è¯¥åœ¨ä¹‹å‰è®²<a href="/2013/01/30/introduction-of-kanyun-worker.html">kanyun workeråŸç†</a>çš„æ—¶å€™è¯´åˆ°äº†ï¼Œå†è¿™é‡Œå°±ä¸èµ˜è¿°äº†</p>

<h3 id="todo">TODO</h3>
<p>åŸºæœ¬å…ˆå†™åˆ°è¿™é‡Œï¼Œå¯¹äºäº†è§£Compute Agentä»£ç è¿è¡Œæœºåˆ¶ï¼Œå¯¹å®ƒè¿›è¡ŒäºŒæ¬¡å¼€å‘ä¹Ÿæœ‰å¾ˆå¤§å¸®åŠ©ï¼Œå†æœ‰å†…å®¹ä»¥åå†è¡¥å……</p>

:ET