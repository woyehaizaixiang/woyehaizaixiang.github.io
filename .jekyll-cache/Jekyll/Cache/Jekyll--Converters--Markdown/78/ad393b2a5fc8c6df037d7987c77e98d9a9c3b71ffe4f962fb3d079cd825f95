I"+<h1 id="pythonè„šæœ¬ä¸‹è½½åˆå¹¶saeæ—¥å¿—">Pythonè„šæœ¬â€“ä¸‹è½½åˆå¹¶SAEæ—¥å¿—</h1>

<blockquote>
  <p>ç”±äºä¸€äº›åŸå› ï¼Œéœ€è¦SAEä¸Šç«™ç‚¹çš„æ—¥å¿—æ–‡ä»¶ï¼Œä»SAEä¸Šåªèƒ½æŒ‰å¤©ä¸‹è½½ï¼Œä¸‹è½½ä¸‹æ¥æ‰‹åŠ¨å¤„ç†æ¯”è¾ƒè›‹ç–¼ï¼Œå°¤å…¶æ˜¯æ•°é‡å¾ˆå¤§çš„æ—¶å€™ã€‚è¿˜å¥½SAEæä¾›äº†APIå¯ä»¥æ‰¹é‡è·å¾—æ—¥å¿—æ–‡ä»¶ä¸‹è½½åœ°å€ï¼Œåˆšåˆšå†™äº†pythonè„šæœ¬è‡ªåŠ¨ä¸‹è½½å’Œåˆå¹¶è¿™äº›æ–‡ä»¶</p>
</blockquote>

<h2 id="è°ƒç”¨apiè·å¾—ä¸‹è½½åœ°å€">è°ƒç”¨APIè·å¾—ä¸‹è½½åœ°å€</h2>
<p>æ–‡æ¡£ä½ç½®åœ¨<a href="http://sae.sina.com.cn/?m=devcenter&amp;catId=281">è¿™é‡Œ</a></p>

<h3 id="è®¾ç½®è‡ªå·±çš„åº”ç”¨å’Œä¸‹è½½å‚æ•°">è®¾ç½®è‡ªå·±çš„åº”ç”¨å’Œä¸‹è½½å‚æ•°</h3>
<p>è¯·æ±‚ä¸­éœ€è¦è®¾ç½®çš„å˜é‡å¦‚ä¸‹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>api_url = 'http://dloadcenter.sae.sina.com.cn/interapi.php?'
appname = 'xxxxx'
from_date = '20140101'
to_date = '20140116'
url_type = 'http' # http|taskqueue|cron|mail|rdc
url_type2 = 'access' # only when type=http  access|debug|error|warning|notice|resources
secret_key = 'xxxxx'
</code></pre></div></div>

<h3 id="ç”Ÿæˆè¯·æ±‚åœ°å€">ç”Ÿæˆè¯·æ±‚åœ°å€</h3>
<p>è¯·æ±‚åœ°å€ç”Ÿæˆæ–¹å¼å¯ä»¥çœ‹ä¸€ä¸‹å®˜ç½‘çš„è¦æ±‚ï¼š</p>

<ol>
  <li>å°†å‚æ•°æ’åº</li>
  <li>ç”Ÿæˆè¯·æ±‚å­—ç¬¦ä¸²ï¼Œå»æ‰<code class="highlighter-rouge">&amp;</code></li>
  <li>é™„åŠ access_key</li>
  <li>è¯·æ±‚å­—ç¬¦ä¸²æ±‚md5ï¼Œå½¢æˆsign</li>
  <li>æŠŠsignå¢åŠ åˆ°è¯·æ±‚å­—ç¬¦ä¸²ä¸­</li>
</ol>

<p>å…·ä½“å®ç°ä»£ç å¦‚ä¸‹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>params = dict()
params['act'] = 'log'
params['appname'] = appname
params['from'] = from_date
params['to'] = to_date
params['type'] = url_type

if url_type == 'http':
    params['type2'] = url_type2

params = collections.OrderedDict(sorted(params.items()))

request = ''
for k,v in params.iteritems():
    request += k+'='+v+'&amp;'

sign = request.replace('&amp;','')
sign += secret_key

md5 = hashlib.md5()
md5.update(sign)
sign = md5.hexdigest()

request = api_url + request + 'sign=' + sign

if response['errno'] != 0:
    print '[!] '+response['errmsg']
    exit()

print '[#] request success'
</code></pre></div></div>

<h2 id="ä¸‹è½½æ—¥å¿—æ–‡ä»¶">ä¸‹è½½æ—¥å¿—æ–‡ä»¶</h2>
<p>SAEå°†æ¯å¤©çš„æ—¥å¿—æ–‡ä»¶éƒ½æ‰“åŒ…æˆtar.gzçš„æ ¼å¼ï¼Œä¸‹è½½ä¿å­˜ä¸‹æ¥å³å¯ï¼Œæ–‡ä»¶åä»¥<code class="highlighter-rouge">æ—¥æœŸ.tar.gz</code>å‘½å</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log_files = list()

for down_url in response['data']:    
    file_name = re.compile(r'\d{4}-\d{2}-\d{2}').findall(down_url)[0] + '.tar.gz'
    log_files.append(file_name)
    data = urllib2.urlopen(down_url).read()
    with open(file_name, "wb") as file:
        file.write(data)

print '[#] you got %d log files' % len(log_files)
</code></pre></div></div>

<h2 id="åˆå¹¶æ–‡ä»¶">åˆå¹¶æ–‡ä»¶</h2>
<p>åˆå¹¶æ–‡ä»¶æ–¹å¼ç”¨trafileåº“è§£å‹ç¼©æ¯ä¸ªæ–‡ä»¶ï¼Œç„¶åæŠŠæ–‡ä»¶å†…å®¹é™„åŠ åˆ°access_logä¸‹å°±å¯ä»¥äº†</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># compress these files to access_log
access_log = open('access_log','w');

for log_file in log_files:
    tar = tarfile.open(log_file)
    log_name = tar.getnames()[0]
    tar.extract(log_name)
    # save to access_log
    data = open(log_name).read()
    access_log.write(data)
    os.remove(log_name)

print '[#] all file has writen to access_log'
</code></pre></div></div>

<h2 id="ä»£ç ä¸‹è½½åœ°å€">ä»£ç ä¸‹è½½åœ°å€</h2>
<p><a href="https://github.com/suyan/Scripts/blob/master/Python/sae-log-download.py">github</a></p>

:ET