I"Š<h2 id="ä¿¡æ¯è·å–">ä¿¡æ¯è·å–</h2>
<p>ä¸»è¦æ˜¯æœ‰å‡ ä¸ªpluginå‡½æ•°ï¼Œä¾æ¬¡è°ƒç”¨ï¼Œå¹¶æŠŠç»“æœå‘ç»™server</p>

<h3 id="è·å¾—ä¸»æœºä¿¡æ¯">è·å¾—ä¸»æœºä¿¡æ¯</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plugin_local_cpu()
ä½¿ç”¨å‘½ä»¤ sleep %d;top -n 1 -b|grep Cpu|awk '{print $2}' æ¥æ£€æµ‹è®¡ç®—èŠ‚ç‚¹ï¼ˆéè™šæ‹Ÿæœºï¼‰cpuå ç”¨ç‡
plugin_traffic_accounting_info()
è·å¾—æµé‡ä¿¡æ¯ï¼Œæµ‹è¯•ä¸å¥½ç”¨
</code></pre></div></div>

<h3 id="è·å¾—å®¿ä¸»æœºä¿¡æ¯">è·å¾—å®¿ä¸»æœºä¿¡æ¯</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plugin_agent_info(){
    import libvirt 
    conn = libvirt.openReadOnly('qemu:///system')
    hostname = conn.getHostname() #è·å¾—ä¸»æœºä¿¡æ¯
    conn.listDomainsID() #åˆ—å‡ºå®¿ä¸»æœº   
    dom_conn = conn.lookupByID(1) #è¿æ¥åˆ°ç¬¬ä¸€å°å®¿ä¸»æœº
    dom_conn.name() #å®¿ä¸»æœºåç§°
    dom_conn.info() #å®¿ä¸»æœºä¿¡æ¯[id,mem_usage,mem_max,vcpu,cpu_time]
    dom_conn.memoryStats() #å®¿ä¸»æœºå†…å­˜ä½¿ç”¨{actual,rss}
}
é€šè¿‡è°ƒç”¨libvirtæ¥è·å–æœ¬å°æœºå™¨ä¸Šè™šæ‹Ÿæœºçš„ä½¿ç”¨æƒ…å†µ
</code></pre></div></div>

<h4 id="è·å¾—cpuä¿¡æ¯">è·å¾—cpuä¿¡æ¯</h4>
<p>è·å¾—cpuä½¿ç”¨ç‡æ–¹å¼ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å®¿ä¸»æœºä¸Šcpuä¸¤æ®µæ—¶é—´cpuè¿è¡Œæ—¶é•¿é—´éš”/ä¸»æœºä¸Šå®é™…æ—¶é•¿é—´éš”
cpu = 100.0 * self.diffs[dom_id].get_diff() / (self.diffs[dom_id].get_time_pass() * dom_nr_virt_cpu * 1e9)
</code></pre></div></div>

<h4 id="è·å¾—å†…å­˜ä¿¡æ¯">è·å¾—å†…å­˜ä¿¡æ¯</h4>
<p>è·å¾—å†…å­˜æ€»é‡å’Œä½¿ç”¨é‡æœ‰info()å’ŒmemoryStats()ä¸¤ä¸ªå‡½æ•°ã€‚
info()å‡½æ•°å–åˆ°çš„å†…å­˜ä¿¡æ¯åœ¨è¿™é‡Œæµ‹è¯•æ—¶ä¸å‡†ç¡®ï¼Œæ¯æ¬¡usageå’Œmaxéƒ½æ˜¯ä¸€æ ·çš„å€¼ï¼Œè€Œä½¿ç”¨memoryStats()å–åˆ°çš„æ˜¯æ­£å¸¸çš„ï¼Œæ²¡æœ‰æ·±ç©¶åŒºåˆ«ï¼Œå…ˆä½¿ç”¨åè€…ã€‚</p>

<h2 id="ä¿¡æ¯å‘é€åˆ°server">ä¿¡æ¯å‘é€åˆ°server</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self.send([msg_type, json.dumps(info)])
</code></pre></div></div>

<p>é€šè¿‡è¿™å¥ä»£ç å°†æ•°æ®å‘é€åˆ°serverç«¯</p>

<p>å…¶ä¸­åŒ…æ‹¬é‡‡é›†åˆ°çš„infoä¿¡æ¯å’Œæœ¬æ¬¡å‘é€ä¿¡æ¯çš„ç±»å‹msg_type</p>
:ET